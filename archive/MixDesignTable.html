import React from 'react';
import { type Selectable } from 'kysely';
import { type MixDesigns } from '../helpers/schema';
import { Button } from './Button';
import { Badge } from './Badge';
import { Edit, Trash2 } from 'lucide-react';
import { useDeleteMixDesign } from '../helpers/mixDesignApi';
import { toast } from 'sonner';
import styles from './MixDesignTable.module.css';

type MixDesignTableProps = {
  mixDesigns: Selectable<MixDesigns>[];
  onEdit: (mixDesign: Selectable<MixDesigns>) => void;
  isUpdating: boolean;
  className?: string;
};

export const MixDesignTable = ({ mixDesigns, onEdit, isUpdating, className }: MixDesignTableProps) => {
  const deleteMutation = useDeleteMixDesign();

  const handleDelete = (id: number) => {
    if (window.confirm('Are you sure you want to delete this mix design? This action cannot be undone.')) {
      deleteMutation.mutate(id, {
        onSuccess: () => {
          toast.success('Mix design deleted successfully!');
        },
        onError: (error) => {
          if (error instanceof Error) {
            toast.error(`Failed to delete mix design: ${error.message}`);
          } else {
            toast.error('An unknown error occurred while deleting the mix design.');
          }
        },
      });
    }
  };

  if (mixDesigns.length === 0) {
    return <div className={styles.emptyState}>No mix designs found. Add one to get started.</div>;
  }

  return (
    <div className={`${styles.tableWrapper} ${isUpdating ? styles.updating : ''} ${className ?? ''}`}>
      <table className={styles.table}>
        <thead>
          <tr>
            <th>Project Name</th>
            <th>Mix Design ID</th>
            <th>Strength (PSI)</th>
            <th>Slump (in)</th>
            <th>Air (%)</th>
            <th>Volume</th>
            <th>Document</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {mixDesigns.map((mix) => (
            <tr key={mix.id}>
              <td>
                <div className={styles.cellPrimary}>{mix.projectName}</div>
              </td>
              <td>
                <div className={styles.cellPrimary}>{mix.mixDesignId}</div>
              </td>
              <td>{mix.specifiedStrengthPsi}</td>
              <td>{mix.slumpInches ? Number(mix.slumpInches).toFixed(1) : 'N/A'}</td>
              <td>{mix.airContentPercent ? Number(mix.airContentPercent).toFixed(1) : 'N/A'}</td>
              <td>
                {mix.batchVolume ? (
                  <>
                    {Number(mix.batchVolume).toFixed(2)}{' '}
                    {mix.volumeUnit === 'cubic_yards' ? 'yd³' : 'm³'}
                  </>
                ) : (
                  'N/A'
                )}
              </td>
              <td>
                {mix.documentName ? (
                  <Badge variant="outline">{mix.documentName}</Badge>
                ) : (
                  <Badge variant="secondary">No Document</Badge>
                )}
              </td>
              <td>
                <div className={styles.actions}>
                  <Button variant="ghost" size="icon-sm" onClick={() => onEdit(mix)}>
                    <Edit size={16} />
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon-sm"
                    onClick={() => handleDelete(mix.id)}
                    disabled={deleteMutation.isPending && deleteMutation.variables === mix.id}
                    className={styles.deleteButton}
                  >
                    <Trash2 size={16} />
                  </Button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};