# Non-Conformance (NC) Management for Safety Module

## ğŸ”„ Complete NC Workflow

This document explains how Non-Conformances (NCs) work in ProSite Safety module, specifically addressing:
1. How NCs are raised by safety officers
2. How contractors are notified
3. How contractors respond and close NCs
4. Notification channels and tracking

---

## ğŸ“‹ NC Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: RAISE NC (Safety Officer)                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ â€¢ Safety officer finds issue during inspection                 â”‚
â”‚ â€¢ Creates NC with details (title, description, severity)       â”‚
â”‚ â€¢ Assigns to specific contractor                               â”‚
â”‚ â€¢ Sets due date for corrective action                          â”‚
â”‚ â€¢ Attaches evidence photos/videos                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: CONTRACTOR NOTIFIED (Automatic)                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ ğŸ“± WhatsApp Notification:                                      â”‚
â”‚    "ğŸ”´ Non-Conformance Raised                                  â”‚
â”‚     NC Number: NC-20251113-00001                               â”‚
â”‚     Title: Unsafe scaffolding at Block A                       â”‚
â”‚     Severity: MAJOR                                            â”‚
â”‚     Due Date: 15-Nov-2025 17:00                                â”‚
â”‚     Please submit corrective action plan ASAP."                â”‚
â”‚                                                                 â”‚
â”‚ ğŸ“§ Email Notification:                                         â”‚
â”‚    Same content in email format                                â”‚
â”‚                                                                 â”‚
â”‚ ğŸ”” In-App Notification:                                        â”‚
â”‚    Dashboard shows "1 Pending NC"                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: CONTRACTOR VIEWS NC                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ Contractor logs into ProSite and sees:                         â”‚
â”‚ â€¢ Dashboard with pending NCs count                             â”‚
â”‚ â€¢ List of NCs assigned to them                                 â”‚
â”‚ â€¢ NC details: description, photos, location, due date          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: CONTRACTOR SUBMITS ACTION (Contractor)                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ â€¢ Contractor reviews NC                                        â”‚
â”‚ â€¢ Submits proposed corrective action plan                      â”‚
â”‚ â€¢ Uploads "before" and "after" photos                          â”‚
â”‚ â€¢ Marks work as completed                                      â”‚
â”‚ â€¢ Submits for verification                                     â”‚
â”‚ â€¢ Status changes: "Pending Action" â†’ "Action Submitted"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: SAFETY OFFICER VERIFIES                                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ Safety officer reviews:                                         â”‚
â”‚ â€¢ Proposed action plan                                         â”‚
â”‚ â€¢ Completion photos                                            â”‚
â”‚                                                                 â”‚
â”‚ Option A: APPROVE âœ…                                           â”‚
â”‚ â€¢ Marks NC as verified and closed                              â”‚
â”‚ â€¢ Contractor receives approval notification                    â”‚
â”‚ â€¢ NC status: "Verified" â†’ "Closed"                             â”‚
â”‚                                                                 â”‚
â”‚ Option B: REJECT âŒ                                            â”‚
â”‚ â€¢ Provides verification notes (what's missing)                 â”‚
â”‚ â€¢ NC goes back to contractor                                   â”‚
â”‚ â€¢ Contractor receives rejection notification                   â”‚
â”‚ â€¢ Status: "Rejected" (loops back to Step 4)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: NC CLOSED âœ…                                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚ â€¢ Final notification sent to contractor                        â”‚
â”‚ â€¢ NC record archived                                           â”‚
â”‚ â€¢ Analytics updated                                            â”‚
â”‚ â€¢ Contractor scorecard updated                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”” How Contractors Know About NCs

### 1. **WhatsApp Notification** (Instant)
When NC is raised, contractor receives WhatsApp message:

```
ğŸ”´ *Non-Conformance Raised*

*NC Number:* NC-20251113-00001
*Title:* Unsafe scaffolding at Block A
*Severity:* MAJOR
*Category:* Safety Violation
*Location:* Block A, Level 3

*Description:*
Scaffolding installed without guardrails. 
Workers exposed to fall hazard.

*Assigned To:* ABC Scaffolding Contractors
*Due Date:* 15-Nov-2025 17:00

âš ï¸ Please submit your corrective action plan ASAP.

_Automated alert from ProSite Safety_
```

### 2. **Email Notification**
Same content sent to contractor's registered email.

### 3. **In-App Dashboard**
When contractor logs into ProSite:
- **Dashboard shows**: "ğŸ”´ 3 Pending NCs"
- **List view**: All NCs with status, due date, severity
- **Filter by**: Pending, Overdue, Rejected, Closed

### 4. **Overdue Alerts**
If contractor doesn't respond before due date:
```
âš ï¸ *Non-Conformance OVERDUE*

*NC Number:* NC-20251113-00001
*Title:* Unsafe scaffolding at Block A
*Due Date:* 15-Nov-2025 17:00

This NC is now overdue. Please submit corrective actions immediately.

_Automated alert from ProSite Safety_
```

---

## ğŸ› ï¸ API Endpoints for NC Management

### **1. Create NC (Safety Officer)**
```bash
POST /api/safety/nc
```

**Request:**
```json
{
  "project_id": 1,
  "nc_title": "Unsafe scaffolding at Block A",
  "nc_description": "Scaffolding installed without guardrails",
  "severity": "major",
  "category": "safety_violation",
  "assigned_to_contractor": "ABC Scaffolding Contractors",
  "assigned_to_user": 15,
  "location": "Block A, Level 3",
  "geo_location": {"lat": 12.345, "lng": 77.678},
  "evidence_photos": ["https://...", "https://..."],
  "due_date": "2025-11-15T17:00:00"
}
```

**Response:**
```json
{
  "success": true,
  "message": "NC NC-20251113-00001 created and contractor notified",
  "nc": {
    "id": 1,
    "nc_number": "NC-20251113-00001",
    "nc_title": "Unsafe scaffolding at Block A",
    "severity": "major",
    "verification_status": "pending_action",
    "is_closed": false
  }
}
```

**Auto Actions:**
- âœ… NC number auto-generated (NC-YYYYMMDD-NNNNN)
- âœ… WhatsApp sent to contractor
- âœ… Email sent to contractor
- âœ… In-app notification created

---

### **2. Get NC Dashboard (Contractor)**
```bash
GET /api/safety/nc/dashboard
```

**Response:**
```json
{
  "success": true,
  "dashboard": {
    "pending_action": 3,
    "action_submitted": 1,
    "overdue": 2,
    "closed": 15,
    "rejected": 1,
    "recent_ncs": [
      {
        "nc_number": "NC-20251113-00001",
        "nc_title": "Unsafe scaffolding",
        "severity": "major",
        "due_date": "2025-11-15T17:00:00",
        "is_overdue": false,
        "verification_status": "pending_action"
      }
    ]
  }
}
```

---

### **3. Get All NCs (Contractor)**
```bash
GET /api/safety/nc
GET /api/safety/nc?status=pending_action
GET /api/safety/nc?is_overdue=true
```

**Response:**
```json
{
  "success": true,
  "ncs": [
    {
      "id": 1,
      "nc_number": "NC-20251113-00001",
      "nc_title": "Unsafe scaffolding at Block A",
      "severity": "major",
      "assigned_to_contractor": "ABC Scaffolding",
      "verification_status": "pending_action",
      "due_date": "2025-11-15T17:00:00"
    }
  ]
}
```

**Auto Filtering:**
- If logged-in user is contractor â†’ Shows only their NCs
- If logged-in user is safety officer â†’ Shows all NCs

---

### **4. Submit Corrective Action (Contractor)**
```bash
POST /api/safety/nc/{nc_id}/action
```

**Request:**
```json
{
  "proposed_action": "Install guardrails on all four sides, add toe boards, ensure double handrails as per code",
  "action_taken": "Guardrails installed and inspected",
  "action_photos": [
    "https://storage.../before.jpg",
    "https://storage.../after.jpg"
  ]
}
```

**Response:**
```json
{
  "success": true,
  "message": "Corrective action submitted for verification",
  "nc": {
    "nc_number": "NC-20251113-00001",
    "verification_status": "action_submitted",
    "action_completion_date": "2025-11-14T10:30:00"
  }
}
```

---

### **5. Verify NC (Safety Officer)**

**Approve:**
```bash
POST /api/safety/nc/{nc_id}/verify
```

```json
{
  "approved": true,
  "verification_notes": "Guardrails properly installed. Complies with safety standards.",
  "closure_remarks": "Satisfactory completion. No further action needed."
}
```

**Reject:**
```json
{
  "approved": false,
  "verification_notes": "Toe boards still missing. Handrails not at proper height (should be 1050mm)."
}
```

**Response (Approved):**
```json
{
  "success": true,
  "message": "NC NC-20251113-00001 verified and closed",
  "nc": {
    "verification_status": "verified",
    "is_closed": true,
    "closed_at": "2025-11-14T15:00:00"
  }
}
```

**Auto Actions:**
- âœ… Contractor receives WhatsApp/Email notification
- âœ… NC marked as closed in database
- âœ… Analytics updated

**Response (Rejected):**
```json
{
  "success": true,
  "message": "NC NC-20251113-00001 rejected. Contractor notified.",
  "nc": {
    "verification_status": "rejected",
    "is_closed": false
  }
}
```

**Auto Actions:**
- âœ… Contractor receives rejection notification with notes
- âœ… NC goes back to contractor for re-work
- âœ… Status: "rejected" (contractor can resubmit action)

---

### **6. Add Comments (Discussion)**
```bash
POST /api/safety/nc/{nc_id}/comments
```

```json
{
  "comment_text": "We need additional materials. Can we get 2 more days extension?",
  "attachments": ["https://storage.../material-quote.pdf"]
}
```

Allows discussion between safety officer and contractor.

---

### **7. Get Notifications**
```bash
GET /api/safety/nc/notifications
```

```json
{
  "success": true,
  "notifications": [
    {
      "notification_type": "nc_raised",
      "subject": "New NC Raised: NC-20251113-00001",
      "notification_channel": "whatsapp",
      "sent_at": "2025-11-13T09:30:00",
      "delivery_status": "sent"
    }
  ]
}
```

---

## ğŸ“Š NC Status Flow

| Status | Description | Who Can Change |
|--------|-------------|----------------|
| `pending_action` | NC raised, waiting for contractor response | Initial state |
| `action_submitted` | Contractor submitted corrective action | Contractor |
| `verified` | Safety officer approved the action | Safety Officer |
| `rejected` | Safety officer rejected (needs re-work) | Safety Officer |
| `closed` | NC fully closed | Safety Officer (after verify) |

---

## ğŸ¯ User Roles & Permissions

### **Safety Officer**
- âœ… Create NC
- âœ… Verify/Reject NC
- âœ… View all NCs
- âœ… Add comments

### **Contractor**
- âœ… View assigned NCs
- âœ… Submit corrective actions
- âœ… Upload photos
- âœ… Add comments
- âŒ Cannot create NC
- âŒ Cannot verify/close NC

### **Admin**
- âœ… Full access to all NCs
- âœ… View analytics
- âœ… Generate reports

---

## ğŸ”” Notification Channels

### **WhatsApp** (Primary)
- Instant delivery
- High read rate
- Includes all NC details
- Sent via Twilio WhatsApp Business API

### **Email** (Secondary)
- Professional communication
- Includes attachments
- Good for record-keeping

### **In-App** (Always)
- Dashboard notifications
- Badge count
- Detailed view with photos

---

## ğŸ“ˆ Analytics & Tracking

### **Contractor Scorecard**
```bash
GET /api/safety/analytics/contractor-scorecard?contractor=ABC
```

Shows:
- Total NCs assigned
- NCs closed on time
- Overdue NCs
- Average closure time
- Rejection rate
- Safety score (0-100)

### **NC Trends**
```bash
GET /api/safety/analytics/nc-trends
```

Shows:
- NCs by severity (minor, major, critical)
- NCs by category (safety, quality, etc.)
- Monthly trends
- Most common violations

---

## ğŸš€ Next Steps

### 1. **Database Migration**
```bash
python3 -c "from server.db import init_db; from server.safety_nc_models import *; init_db()"
```

Creates tables:
- `safety_non_conformances`
- `safety_nc_comments`
- `safety_contractor_notifications`

### 2. **Test NC Workflow**
```bash
# 1. Safety officer creates NC
curl -X POST http://localhost:5000/api/safety/nc \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{...}'

# 2. Contractor views NCs
curl http://localhost:5000/api/safety/nc/dashboard \
  -H "Authorization: Bearer <contractor-token>"

# 3. Contractor submits action
curl -X POST http://localhost:5000/api/safety/nc/1/action \
  -H "Authorization: Bearer <contractor-token>" \
  -d '{...}'

# 4. Safety officer verifies
curl -X POST http://localhost:5000/api/safety/nc/1/verify \
  -H "Authorization: Bearer <token>" \
  -d '{"approved": true, ...}'
```

### 3. **Frontend Integration**
Build UI screens:
- NC creation form (safety officer)
- NC dashboard (contractor)
- NC details with photo viewer
- Comment/discussion thread
- Verification interface

---

## ğŸ’¡ Example Scenario

**Scenario**: Safety officer finds scaffolding issue

1. **09:00 AM** - Safety officer inspects site, finds unsafe scaffolding
2. **09:15 AM** - Creates NC in ProSite app with photos
3. **09:15 AM** - Contractor "ABC Scaffolding" receives WhatsApp:
   ```
   ğŸ”´ NC Raised: NC-20251113-00001
   Unsafe scaffolding - Missing guardrails
   Due: 15-Nov-2025 17:00
   ```
4. **10:00 AM** - Contractor logs into ProSite, sees "1 Pending NC"
5. **10:30 AM** - Contractor reviews NC details, photos, location
6. **11:00 AM** - Contractor submits action plan: "Will install guardrails by 2 PM"
7. **02:00 PM** - Work completed, contractor uploads "after" photos
8. **02:30 PM** - Safety officer receives notification "Action submitted"
9. **03:00 PM** - Safety officer inspects work, approves closure
10. **03:01 PM** - Contractor receives:
    ```
    âœ… NC Closed: NC-20251113-00001
    Your corrective actions verified and approved.
    ```

---

## ğŸ” Security Features

- âœ… Company data isolation (multi-tenant safe)
- âœ… Role-based access control
- âœ… JWT authentication required
- âœ… Contractors see only their NCs
- âœ… Audit trail (who raised, who verified, timestamps)
- âœ… Photo evidence with timestamps

---

## ğŸ“‹ Summary

**Key Features:**
1. âœ… **Instant Notifications**: WhatsApp + Email + In-App
2. âœ… **Clear Assignment**: NC assigned to specific contractor
3. âœ… **Photo Evidence**: Before/after photos for verification
4. âœ… **Discussion Thread**: Comments for clarifications
5. âœ… **SLA Tracking**: Due dates and overdue alerts
6. âœ… **Verification Workflow**: Approve/Reject with notes
7. âœ… **Analytics**: Contractor scorecard and NC trends

**Benefits:**
- Contractors always know about NCs (multiple notification channels)
- Clear workflow from raise â†’ action â†’ verify â†’ close
- Evidence-based closure (photos required)
- Accountability (who did what, when)
- Compliance tracking (ISO 9001, safety standards)

---

*This NC system ensures zero miscommunication between safety officers and contractors, with built-in notifications and tracking at every step.*
